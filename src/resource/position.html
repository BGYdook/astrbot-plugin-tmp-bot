<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <link href="./package/leaflet/leaflet.min.css" rel="stylesheet">
  <script src="./package/leaflet/leaflet.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
    }
    * {
      font-family: "微软雅黑", serif;
    }
    #container {
      width: 500px;
      height: 320px;
      position: relative;
    }
    .map {
      width: 100%;
      height: 100%;
      background-color: #5d5d5d;
    }
    .user-info-box {
      width: 100%;
      height: 76px;
      position: absolute;
      bottom: 0;
      z-index: 999;
      background-color: rgba(100, 100, 100, 0.4);
      backdrop-filter: blur(6px);
      display: flex;
      flex-direction: row;
      align-items: center;
      padding: 0 14px;
      box-sizing: border-box;
    }
    .avatar {
      width: 56px;
      height: 56px;
      border-radius: 4px;
    }
    .user {
      height: 56px;
      width: 220px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .user {
      font-size: 16px;
      color: #eeeeee;
      margin-left: 10px;
      box-sizing: border-box;
    }
    .user .server-name-box {
      display: flex;
      align-items: center;
      margin-top: 4px;
    }
    .user .username {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .user .server-name-box span {
      display: inline-block;
      max-width: 136px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 4px;
      box-sizing: border-box;
    }
    .location-box {
      flex-grow: 1;
      color: #eeeeee;
      font-size: 16px;
      height: 56px;
      box-sizing: border-box;
      border-right: 4px solid #54d354;
      text-align: right;
      padding-right: 6px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .location-box>* {
      width: 174px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="map" class="map"></div>
    <div class="user-info-box">
      <img class="avatar" src="https://static.truckersmp.com/avatarsN/small/defaultavatar.png"/>
      <div class="user">
        <div class="username">...</div>
        <div class="server-name-box" style="margin-top: 4px">
          <span class="server-name">...</span>游戏中
        </div>
      </div>
      <div class="location-box">
        <div class="country">...</div>
        <div class="real-name" style="margin-top: 4px">...</div>
      </div>
    </div>
  </div>
  <script>
    function addTileLayerWithFallback (map, urlTemplate, options) {
      if (!urlTemplate || !String(urlTemplate).trim()) {
        return null
      }

      const tileLayer = L.tileLayer(urlTemplate, options)

      let tileErrorCount = 0
      tileLayer.on('tileerror', function () {
        tileErrorCount += 1
        if (tileErrorCount === 12) {
          tileLayer.remove()
          const control = L.control({ position: 'topleft' })
          control.onAdd = function () {
            const div = L.DomUtil.create('div')
            div.style.padding = '6px 8px'
            div.style.margin = '8px'
            div.style.borderRadius = '6px'
            div.style.background = 'rgba(0,0,0,0.45)'
            div.style.color = '#ffffff'
            div.style.fontSize = '12px'
            div.style.lineHeight = '16px'
            div.innerText = '底图加载失败'
            return div
          }
          control.addTo(map)
        }
      })

      tileLayer.addTo(map)
      return tileLayer
    }

    let mapConfig = {
      ets: {
        tileUrl: 'https://map-cdn.krashnz.com/ets2map/ets2/v1.57/{x}_{y}.png',
        bounds: {
          y: 65536,
          x: 65536
        },
        maxZoom: 8,
        minZoom: 2,
        // 游戏地转地图坐标
        calculateMapCoordinate (xx, yy) {
          var MAX_X = 65536;
          var MAX_Y = 65536;
          const x1 = -113177.313;
          const x2 = 97925.625;
          const y1 = -122648.086;
          const y2 = 88454.85;

          const xtot = x2 - x1;
          const ytot = y2 - y1;

          const xrel = (xx - x1) / xtot;
          const yrel = (yy - y1) / ytot;

          return [
            xrel * MAX_X,
            yrel * MAX_Y
          ];
        }
      },
      promods: {
        tileUrl: 'https://map-cdn.krashnz.com/ets2map/promods/v2.80/{x}_{y}.png',
        bounds: {
          y: 65536,
          x: 65536
        },
        maxZoom: 8,
        minZoom: 2,
        // 游戏地转地图坐标
        calculateMapCoordinate (xx, yy) {
          var MAX_X = 65536;
          var MAX_Y = 65536;
          const x1 = -135110.156;
          const x2 = 168923.75;
          const y1 = -190095.016;
          const y2 = 113938.891;

          const xtot = x2 - x1;
          const ytot = y2 - y1;

          const xrel = (xx - x1) / xtot;
          const yrel = (yy - y1) / ytot;

          return [
            xrel * MAX_X,
            yrel * MAX_Y
          ];
        }
      }
    }

    // 定义地图
    let map = L.map('map', {
      attributionControl: false,
      crs: L.CRS.Simple,
      zoomControl: false
    });
    let tileLayer = null

    function setData(data) {
      if (data && data.mapTileEts) mapConfig.ets.tileUrl = data.mapTileEts
      if (data && data.mapTilePromods) mapConfig.promods.tileUrl = data.mapTilePromods

      // 边界
      let bounds = L.latLngBounds(
        map.unproject([0, mapConfig[data.mapType].bounds.y], mapConfig[data.mapType].maxZoom),
        map.unproject([mapConfig[data.mapType].bounds.x, 0], mapConfig[data.mapType].maxZoom)
      );

      if (tileLayer) {
        try {
          tileLayer.remove()
        } catch {}
        tileLayer = null
      }
      tileLayer = addTileLayerWithFallback(map, mapConfig[data.mapType].tileUrl, {
        minZoom: mapConfig[data.mapType].minZoom,
        maxZoom: 10,
        maxNativeZoom: mapConfig[data.mapType].maxZoom,
        tileSize: 256,
        bounds: bounds,
        reuseTiles: true
      })

      map.setMaxBounds(
        new L.LatLngBounds(
          map.unproject([0, mapConfig[data.mapType].bounds.y], mapConfig[data.mapType].maxZoom),
          map.unproject([mapConfig[data.mapType].bounds.x, 0], mapConfig[data.mapType].maxZoom)
        )
      );

      document.getElementsByClassName('avatar')[0].src = data.avatar
      document.getElementsByClassName('username')[0].innerText = data.username
      document.getElementsByClassName('server-name')[0].innerText = data.serverName
      document.getElementsByClassName('country')[0].innerText = data.country
      document.getElementsByClassName('real-name')[0].innerText = data.realName

      if (Array.isArray(data.markerList)) {
        for (let marker of data.markerList) {
          if (!marker || typeof marker.axisX !== 'number' || typeof marker.axisY !== 'number') continue
          L.circleMarker(map.unproject(mapConfig[data.mapType].calculateMapCoordinate(marker.axisX, marker.axisY), 8), {
            color: 'rgba(0,0,0,0)',
            weight: 0,
            fillColor: '#ffcc00',
            fillOpacity: 0.45,
            radius: 2
          }).addTo(map);
        }
      }

      for (let player of data.playerList) {
        L.circleMarker(map.unproject(mapConfig[data.mapType].calculateMapCoordinate(player.axisX, player.axisY), 8), {
          color: '#2f2f2f',       // 标记点边框颜色
          weight: 2,              // 标记点边框大小
          fillColor: data.currentPlayerId.toString() === player.tmpId.toString() ? '#1cb715' : '#158cfb',   // 标记点填充颜色
          fillOpacity: 1,         // 标记点填充不透明度（0到1之间的值）
          radius: 5,              // 标记点半径（以像素为单位）
          zIndex: data.currentPlayerId.toString() === player.tmpId.toString() ? 1000 : undefined
        }).addTo(map);
      }

      // 移动地图到坐标，视角稍微向上移动
      map.setView(map.unproject(mapConfig[data.mapType].calculateMapCoordinate(data.centerX, data.centerY + 80), 8), 7);
    }
  </script>
</body>
</html>
